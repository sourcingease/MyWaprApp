<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>AP Payment</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico">
  <link rel="stylesheet" href="/app.css" />
  <style>
    body{margin:0;background:#f5f7fa;font-family:Inter,Segoe UI,Arial;color:#0f172a}
    .shell{max-width:900px;margin:0 auto;padding:16px}
    .card{background:#fff;border:1px solid #e2e8f0;border-radius:12px;box-shadow:0 1px 3px rgba(0,0,0,.06);padding:16px}
    .row{display:grid;grid-template-columns:1fr 1fr;gap:12px}
    @media (max-width: 720px){ .row{grid-template-columns:1fr} }
    .muted{color:#475569}
  </style>
</head>
<body>
  <div class="dashboard-header"><div class="header-left"><img src="/logo.png" class="logo-small"><div class="dashboard-title">AP Payment</div></div><div class="header-right"></div></div>
  <div class="shell">
    <div class="card">
      <div id="meta" class="muted" style="margin-bottom:8px"></div>
      <div class="row">
        <div class="form-group"><label class="form-label">Order / Job ID</label><input id="orderId" class="form-input" disabled></div>
        <div class="form-group"><label class="form-label">Product Name</label><input id="productName" class="form-input" disabled></div>
        <div class="form-group"><label class="form-label">Supplier Name</label><input id="supplierName" class="form-input" disabled></div>
        <div class="form-group"><label class="form-label">Product Due Date</label><input id="dueDate" class="form-input" disabled></div>
        <div class="form-group"><label class="form-label">Amount Payable</label><input id="amount" class="form-input" type="number" step="0.01"></div>
        <div class="form-group"><label class="form-label">Bank</label><select id="bank" class="form-select"></select><div id="bal" class="muted"></div></div>
        <div class="form-group"><label class="form-label">Slip Number</label><input id="slip" class="form-input"></div>
        <div class="form-group"><label class="form-label">Notes</label><input id="notes" class="form-input"></div>
        <div class="form-group" style="grid-column:1 / -1"><label class="form-label">Attachment</label><input id="file" type="file" class="form-input"></div>
      </div>
      <div style="margin-top:12px;display:flex;gap:8px;justify-content:flex-end">
        <button class="ct" onclick="goBack()">Back</button>
        <button class="ct primary" onclick="save()">Pay</button>
      </div>
      <div id="msg" class="status-message" style="display:none"></div>
    </div>
  </div>
  <script src="/js/master-layout.js"></script>
  <script>
    function qs(k){ const u=new URL(location.href); return u.searchParams.get(k); }
    function esc(s){ return String(s).replace(/[&<>"']/g,c=>({"&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#39;"}[c])); }
    function embedded(){ return new URL(location.href).searchParams.get('embedded')==='1'; }
    if(embedded()){ const h=document.querySelector('.dashboard-header'); if(h) h.style.display='none'; }
    async function fetchJson(url, options){ const res=await fetch(url,{credentials:'include',...(options||{})}); if(!res.ok) throw new Error(await res.text()); return res.json(); }
    function show(ok,t){ const m=document.getElementById('msg'); m.className='status-message '+(ok?'success':'error'); m.textContent=t; m.style.display='block'; }
    async function load(){ const id=parseInt(qs('id')||''); const ap=await fetchJson(`/api/accounting/ap?status=Approved`); const row=(ap.data||[]).find(x=>x.Id===id);
      if(!row){ document.getElementById('meta').textContent='Invoice not found'; return; }
      orderId.value=row.OrderId||''; productName.value=row.ProductName||''; supplierName.value=row.SupplierName||''; dueDate.value=row.DueDate? new Date(row.DueDate).toLocaleDateString():''; amount.value=Number(row.Amount||0).toFixed(2);
      const b=await fetchJson('/api/accounting/bank-summary'); const list=b.data||[]; bank.innerHTML=list.map(x=>`<option value='${x.BankId}'>${esc(x.Name)} â€¢ ${esc(x.AccountNumber||'')}</option>`).join('');
      bank.onchange=()=>{ const cur=list.find(x=>x.BankId===parseInt(bank.value||'')); document.getElementById('bal').textContent = cur? (`Balance: $${Number(cur.Balance||0).toFixed(2)}`):''; }; bank.onchange();
    }
    async function uploadIfAny(){ const f=document.getElementById('file').files[0]; if(!f) return null; const b=await fileToDataURL(f); const r=await fetchJson('/api/uploads',{ method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ dataUrl:b, filename:'ap-doc' }) }); return r.url; }
    function fileToDataURL(file){ return new Promise((res,rej)=>{ const r=new FileReader(); r.onload=()=>res(r.result); r.onerror=rej; r.readAsDataURL(file); }); }
    async function save(){ try{ const id=parseInt(qs('id')||''); const bankId=parseInt(bank.value||''); const amt=parseFloat(amount.value||0)||0; const docUrl=await uploadIfAny(); const payload={ bankId, amount:amt, notes: (notes.value||''), slipNumber: (slip.value||''), docUrl };
        await fetchJson(`/api/accounting/ap/${id}/pay`, { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(payload) }); show(true,'Paid'); setTimeout(()=> goBack(), 700);
      }catch(e){ console.error(e); show(false,'Failed to pay'); }
    }
    function goBack(){ const url='/accounting/dashboard.html'+(embedded()?'?embedded=1':''); location.href=url; }
    load();
  </script>
</body>
</html>
