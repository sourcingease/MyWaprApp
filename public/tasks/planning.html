<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Task Planner â€¢ ComplytEX</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico">
  <link rel="stylesheet" href="/app.css">
  <style>
    body{margin:0;font-family:Segoe UI,Inter,Arial;background:#ffffff;color:#0f172a}
    .shell{max-width:1200px;margin:0 auto;padding:22px}
    .row{display:flex;gap:12px;align-items:center;flex-wrap:wrap}
    .muted{color:#64748b}
    .calendar{display:grid;grid-template-columns:repeat(7,1fr);gap:6px;margin-top:8px}
    .day{padding:6px;border-radius:6px;text-align:center;background:#ffffff;border:1px solid #e2e8f0;cursor:pointer}
    .day.today{outline:2px solid #7c3aed;background:#f5f3ff}
    .day.sel{background:#f1f5f9;border-color:#cbd5e1}
    .timeline{display:grid;grid-template-columns:150px repeat(24,1fr);border:1px solid #e2e8f0;border-radius:10px;margin-top:14px;overflow:hidden;position:relative;background:#ffffff}
    .t-head{background:#f8fafc}
    .t-cell{padding:8px;border-right:1px solid #e2e8f0;font-size:12px;color:#64748b;text-align:center}
    .t-row{display:contents}
    .u-cell{background:#ffffff;padding:10px;border-top:1px solid #e2e8f0}
    .g-cell{position:relative;height:54px;border-top:1px solid #e2e8f0;border-right:1px dashed #e2e8f0;background:#ffffff}
    .task{position:absolute;height:42px;background:#7c3aed;color:#ffffff;border-radius:8px;padding:6px 8px;font-size:12px;cursor:grab;box-shadow:0 2px 6px rgba(0,0,0,.15)}
    .task .h{position:absolute;top:0;bottom:0;width:6px;cursor:ew-resize}
    .task .h.l{left:0}
    .task .h.r{right:0}
    .selection{position:absolute;height:42px;background:#22c55e22;border:2px dashed #22c55e;border-radius:8px;pointer-events:none}
    .btn{padding:8px 12px;border-radius:8px;border:1px solid #e2e8f0;background:#0ea5e9;color:#ffffff;cursor:pointer}
    input,textarea,select{padding:10px;border-radius:8px;border:1px solid #e2e8f0;background:#ffffff;color:#0f172a}
    dialog{border:1px solid #e2e8f0;background:#ffffff;color:#0f172a;border-radius:12px;padding:16px}
  </style>
</head>
<body>
  <div class="shell">
    <h2>Task Planner</h2>
    <div class="row">
      <div>
        <div class="muted">Mini Calendar</div>
        <div id="miniCal" class="calendar"></div>
      </div>
      <div>
        <div class="muted">Selected Date</div>
        <div id="selDate" style="font-weight:700;font-size:18px"></div>
      </div>
      <button class="btn" onclick="newTaskNow()">+ New Task Now</button>
    </div>

    <div id="timeline" class="timeline"></div>
  </div>

  <dialog id="taskModal">
    <form method="dialog" onsubmit="return false;" id="taskForm">
      <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px">
        <label>Start <input id="m_startdt" type="datetime-local"/></label>
        <label>End <input id="m_enddt" type="datetime-local"/></label>
        <label>Task <input id="m_title"/></label>
        <label>Task Description <textarea id="m_desc" rows="2"></textarea></label>
        <label>Upload Image (if any) <input id="m_file" type="file" accept="image/*"/></label>
        <label>Task Priority
          <select id="m_priority">
            <option value="Low">Low</option>
            <option value="Normal">Normal</option>
            <option value="High" selected>High</option>
          </select>
        </label>
        <label>Assign To
          <select id="m_assignTo"></select>
        </label>
        <label class="full">Note <textarea id="m_note" rows="3"></textarea></label>
        <label>Assign By <input id="m_assignBy" type="email"/></label>
        <label>Repeat
          <select id="m_repeat">
            <option value="none">Does not repeat</option>
            <option value="daily">Daily</option>
            <option value="weekly">Weekly</option>
            <option value="monthly">Monthly</option>
          </select>
        </label>
      </div>
      <div style="margin-top:12px;display:flex;gap:8px;justify-content:flex-end">
        <button class="btn" onclick="saveModal()">OK</button>
        <button class="btn" style="background:#64748b" onclick="closeModal()">Cancel</button>
      </div>
    </form>
  </dialog>

  <script src="/js/tasks-api-client.js"></script>
  <script>
    const users=[{id:1,name:'Sam Safety'},{id:2,name:'Alex Auditor'},{id:3,name:'Maria Manager'},{id:4,name:'Manny Facturer'},{id:5,name:'Sue Plier'},{id:6,name:'Hugh Mann'}];
    let tasks=[{id:'t1',title:'Daily Brief',assigneeId:1,startHour:9,endHour:10},{id:'t2',title:'Floor Check',assigneeId:2,startHour:11,endHour:13}];
    let currentDate=new Date();
    let editing=null;
    let selecting=false; let selStart=null; let selEnd=null; let selEl=null;
    let resizing=null; // {id, side:'l'|'r'}

    // email mapping for Assign To dropdown (id <-> email)
    const userEmailById={1:'aliya@arshco.com',2:'alex@arshco.com',3:'maria@arshco.com',4:'manny@arshco.com',5:'sue@arshco.com',6:'hugh@arshco.com'};
    const userIdByEmail=Object.fromEntries(Object.entries(userEmailById).map(([k,v])=>[v, Number(k)]));
    const currentUserEmail = (localStorage.getItem('userEmail')||'umair55@arshco.com');

    function fmtDate(d){return d.toLocaleDateString(undefined,{weekday:'long',month:'long',day:'numeric',year:'numeric'})}

    function buildCalendar(){
      const el=document.getElementById('miniCal'); el.innerHTML='';
      const base=new Date(currentDate.getFullYear(),currentDate.getMonth(),1);
      const start=new Date(base); start.setDate(1 - ((base.getDay()+6)%7));
      for(let i=0;i<42;i++){
        const day=new Date(start); day.setDate(start.getDate()+i);
        const b=document.createElement('button'); b.className='day'; b.textContent=day.getDate();
        if(day.toDateString()===new Date().toDateString()) b.classList.add('today');
        if(day.toDateString()===currentDate.toDateString()) b.classList.add('sel');
        b.onclick=()=>{currentDate=new Date(day); document.getElementById('selDate').textContent=fmtDate(currentDate); buildCalendar(); loadTasks();};
        el.appendChild(b);
      }
    }

    function rowTop(userId){
      // use the 0h cell as anchor
      const cell=document.getElementById(`cell_${userId}_0`);
      const host=document.getElementById('timeline');
      return cell ? (cell.offsetTop + 6) : 6;
    }

    function renderTimeline(){
      const host=document.getElementById('timeline'); host.innerHTML='';
      // header
      const headRow=document.createElement('div'); headRow.className='t-row t-head';
      const uHead=document.createElement('div'); uHead.className='t-cell'; uHead.style.gridColumn='span 1'; uHead.textContent='User'; headRow.appendChild(uHead);
      for(let h=0;h<24;h++){const c=document.createElement('div'); c.className='t-cell'; c.textContent=h.toString().padStart(2,'0'); headRow.appendChild(c);} host.appendChild(headRow);
      // rows
      users.forEach(u=>{
        const name=document.createElement('div'); name.className='u-cell'; name.textContent=u.name; host.appendChild(name);
        for(let h=0;h<24;h++){
          const cell=document.createElement('div'); cell.className='g-cell';
          cell.id=`cell_${u.id}_${h}`;
          cell.dataset.user=u.id; cell.dataset.hour=h;
          // drag move between rows/hours
          cell.ondragover=(e)=>e.preventDefault();
          cell.ondrop=async (e)=>{const id=e.dataTransfer.getData('taskId'); if(!id) return; const t=tasks.find(x=>x.id===id); const dur=t.endHour-t.startHour; t.assigneeId=u.id; t.startHour=h; t.endHour=Math.min(24,h+dur); renderTimeline(); try{ await TasksAPI.updateTask(t.id,{date:currentDate.toISOString().slice(0,10), assigneeId:t.assigneeId, startHour:t.startHour, endHour:t.endHour, title:t.title}); }catch(err){ alert('Save failed: '+err.message); }};
          // click to create
          cell.onclick=()=>{ if(selecting) return; openModal({id:'new',title:'New Task',assigneeId:u.id,startHour:h,endHour:Math.min(24,h+1)}); };
          // drag-to-create selection
          cell.onmousedown=(e)=>{selecting=true; selStart={u:u.id,h}; selEnd={u:u.id,h}; showSelection(); e.preventDefault(); };
          cell.onmouseenter=()=>{ if(!selecting) return; if(selStart && selStart.u===u.id){ selEnd={u:u.id,h}; showSelection(); } };
          cell.onmouseup=()=>{ if(!selecting) return finalizeSelection(); };
          host.appendChild(cell);
        }
        // tasks for user
        (tasks.filter(t=>t.assigneeId===u.id)).forEach(t=>{
          const leftPct=(t.startHour/24)*100; const widthPct=((t.endHour-t.startHour)/24)*100;
          const tEl=document.createElement('div'); tEl.className='task'; tEl.textContent=t.title;
          tEl.style.left=`calc(150px + ${leftPct}%)`; tEl.style.width=`calc(${widthPct}% - 8px)`;
          tEl.style.top = rowTop(u.id) + 'px';
          tEl.draggable=true; tEl.ondragstart=(e)=>e.dataTransfer.setData('taskId',t.id);
          tEl.onclick=(e)=>{e.stopPropagation(); openModal({...t});};
          // resize handles
          const hl=document.createElement('div'); hl.className='h l'; hl.onmousedown=(e)=>{e.stopPropagation(); resizing={id:t.id,side:'l'}; document.addEventListener('mousemove',onResizeMove); document.addEventListener('mouseup',onResizeEnd);};
          const hr=document.createElement('div'); hr.className='h r'; hr.onmousedown=(e)=>{e.stopPropagation(); resizing={id:t.id,side:'r'}; document.addEventListener('mousemove',onResizeMove); document.addEventListener('mouseup',onResizeEnd);};
          tEl.appendChild(hl); tEl.appendChild(hr);
          host.appendChild(tEl);
        });
      });
    }

    function timelineMetrics(){
      const host=document.getElementById('timeline');
      const rect=host.getBoundingClientRect();
      const totalWidth=rect.width; const nameCol=150; const gridWidth=totalWidth-nameCol;
      return {rect, nameCol, gridWidth, hourWidth: gridWidth/24};
    }

    function onResizeMove(e){
      if(!resizing) return;
      const t=tasks.find(x=>x.id===resizing.id); if(!t) return;
      const {rect,nameCol,hourWidth}=timelineMetrics();
      const x=e.clientX-rect.left-nameCol; const hour=Math.min(24,Math.max(0,Math.round(x/hourWidth)));
      if(resizing.side==='l'){
        t.startHour=Math.min(t.endHour-1,Math.max(0,hour));
      } else {
        t.endHour=Math.max(t.startHour+1,Math.min(24,hour));
      }
      renderTimeline();
    }
    async function onResizeEnd(){
      if(resizing){
        const t=tasks.find(x=>x.id===resizing.id);
        try{ await TasksAPI.updateTask(t.id,{date:currentDate.toISOString().slice(0,10), assigneeId:t.assigneeId, startHour:t.startHour, endHour:t.endHour, title:t.title}); }
        catch(err){ alert('Save failed: '+err.message); }
      }
      resizing=null; document.removeEventListener('mousemove',onResizeMove); document.removeEventListener('mouseup',onResizeEnd);
    }

    function showSelection(){
      if(!selEl){ selEl=document.createElement('div'); selEl.className='selection'; document.getElementById('timeline').appendChild(selEl); }
      const u=selStart.u; const h1=Math.min(selStart.h, selEnd.h); const h2=Math.max(selStart.h, selEnd.h)+1;
      const leftPct=(h1/24)*100; const widthPct=((h2-h1)/24)*100;
      selEl.style.left = `calc(150px + ${leftPct}%)`;
      selEl.style.width = `calc(${widthPct}% - 8px)`;
      selEl.style.top = rowTop(u) + 'px';
    }
    function finalizeSelection(){
      selecting=false; const u=selStart.u; const start=Math.min(selStart.h, selEnd.h); const end=Math.max(selStart.h, selEnd.h)+1;
      if(selEl){ selEl.remove(); selEl=null; }
      openModal({id:'new',title:'New Task',assigneeId:u,startHour:start,endHour:end});
      selStart=selEnd=null;
    }

    function pad2(n){ return String(n).padStart(2,'0'); }
    function toLocalInputValue(d){
      const y=d.getFullYear(); const m=pad2(d.getMonth()+1); const da=pad2(d.getDate());
      const h=pad2(d.getHours()); const mi=pad2(d.getMinutes());
      return `${y}-${m}-${da}T${h}:${mi}`;
    }
    function openModal(t){ editing=t; const m=document.getElementById('taskModal');
      document.getElementById('m_title').value=t.title||'';
      // init start/end default using currentDate + hours
      const s=new Date(currentDate); s.setHours(t.startHour||0,0,0,0);
      const e=new Date(currentDate); e.setHours(Math.max((t.endHour||1),(t.startHour||0)+1),0,0,0);
      document.getElementById('m_startdt').value = toLocalInputValue(s);
      document.getElementById('m_enddt').value = toLocalInputValue(e);
      // assign to options
      const sel = document.getElementById('m_assignTo');
      sel.innerHTML = Object.values(userEmailById).map(em=>`<option value="${em}">${em}</option>`).join('');
      sel.value = userEmailById[t.assigneeId] || Object.values(userEmailById)[0];
      document.getElementById('m_priority').value = 'High';
      document.getElementById('m_assignBy').value = currentUserEmail;
      document.getElementById('m_desc').value = '';
      document.getElementById('m_note').value = '';
      document.getElementById('m_repeat').value = 'none';
      m.showModal();
    }
    function closeModal(){ document.getElementById('taskModal').close(); }
    async function saveModal(){
      const title=(document.getElementById('m_title').value||'').trim()||'Task';
      const startStr=document.getElementById('m_startdt').value; const endStr=document.getElementById('m_enddt').value;
      if(!startStr||!endStr){ alert('Start and End are required'); return; }
      const startDT=new Date(startStr); const endDT=new Date(endStr);
      if(!(endDT>startDT)){ alert('End must be after Start'); return; }
      // derive API-compatible fields
      const dateStr = startDT.toISOString().slice(0,10);
      const startHour = startDT.getHours();
      const endHour = Math.min(24, Math.max(startHour+1, Math.ceil(endDT.getHours() + endDT.getMinutes()/60)));
      const assigneeEmail = document.getElementById('m_assignTo').value;
      const assigneeId = userIdByEmail[assigneeEmail] || (editing.assigneeId||1);

      if(editing.id==='new'){
        const payload={ date: dateStr, title, assigneeId, startHour, endHour };
        try{ const newId = await TasksAPI.createTask(payload); tasks.push({id:newId||('t'+Math.random().toString(36).slice(2,7)), ...payload}); }
        catch(err){ alert('Create failed: '+err.message); }
      } else {
        const t=tasks.find(x=>x.id===editing.id); if(t){ t.title=title; t.startHour=startHour; t.endHour=endHour; t.assigneeId=assigneeId; }
        try{ await TasksAPI.updateTask(editing.id,{date:dateStr, title, assigneeId, startHour, endHour}); }
        catch(err){ alert('Save failed: '+err.message); }
      }
      closeModal(); renderTimeline();
    }
    function newTaskNow(){ openModal({id:'new',title:'New Task',assigneeId:users[0].id,startHour:new Date().getHours(),endHour:Math.min(24,new Date().getHours()+1)}); }

    document.getElementById('selDate').textContent=fmtDate(currentDate);
    buildCalendar();
    async function loadTasks(){
      try{ tasks = await TasksAPI.listTasks(currentDate.toISOString().slice(0,10)); }
      catch(err){ console.warn('Failed to load tasks', err); tasks = []; }
      renderTimeline();
    }
    loadTasks();
  </script>
</body>
</html>
