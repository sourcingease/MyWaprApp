<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Attendance • Admin</title>
  <link rel="stylesheet" href="/app.css" />
  <style>
    body{margin:0;font-family:Inter,Segoe UI,Arial;background:#f5f7fa;color:#0f172a}
    .shell{max-width:1100px;margin:0 auto;padding:22px}
    .card{background:#fff;border:1px solid #e2e8f0;border-radius:12px;padding:16px;box-shadow:0 1px 3px rgba(0,0,0,.05);margin-bottom:16px}
    .row{display:flex;gap:12px;flex-wrap:wrap;align-items:flex-end}
    label{font-size:13px;font-weight:600;color:#334155}
    input,select,textarea{padding:10px 12px;border:1px solid #e2e8f0;border-radius:8px;font:inherit}
    table{width:100%;border-collapse:collapse}
    th,td{padding:10px;border-bottom:1px solid #e2e8f0;font-size:14px}
    th{background:#f8fafc;text-align:left;text-transform:uppercase;font-size:12px;color:#475569}
    .barcode{padding:8px;border:1px dashed #e2e8f0;display:inline-block;background:#fff}
  </style>
</head>
<body>
  <div class="shell">
    <h2>Attendance • Admin</h2>

    <div class="card">
      <div class="row">
        <div style="flex:1 1 260px"><label>Employee</label><select id="emp" style="width:100%"></select></div>
        <div style="flex:1 1 260px"><label>Barcode</label><input id="code" style="width:100%" placeholder="e.g. TEN1-EMP1001"/></div>
        <div style="flex:1 1 260px"><label>Photo URL</label><input id="photo" style="width:100%" placeholder="https://..."/></div>
        <div><label>&nbsp;</label><button class="btn" onclick="saveMap()">Save</button></div>
        <div><label>&nbsp;</label><button class="btn sec" onclick="genCode()">Generate</button></div>
      </div>
      <div class="row" style="margin-top:8px">
        <div id="preview" class="barcode"></div>
        <div><button class="btn sec" onclick="printBarcode()">Print</button></div>
      </div>
    </div>

    <div class="card">
      <div class="row">
        <div style="flex:1 1 260px"><label>Search</label><input id="q" placeholder="name/email/barcode" style="width:100%" oninput="loadMaps()"/></div>
      </div>
      <div class="data-table-container" style="margin-top:10px">
        <table>
          <thead><tr><th>Name</th><th>Email</th><th>Barcode</th><th>Photo</th><th>Actions</th></tr></thead>
          <tbody id="rows"></tbody>
        </table>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/jsbarcode@3.11.6/dist/JsBarcode.all.min.js"></script>
  <script src="/js/safety-api-client.js"></script>
  <script>
    const tenantId = 1;

    async function loadEmployees(){
      const res = await fetch(`/api/tenant/${tenantId}/employees`);
      const data = await res.json();
      const sel = document.getElementById('emp');
      sel.innerHTML = (data.data||[]).map(e=>`<option value="${e.UserId}">${e.FullName||e.Email}</option>`).join('');
    }

    async function loadMaps(){
      const q = document.getElementById('q').value.trim();
      const res = await SafetyAPI.listAttendanceBarcodes({ tenantId, q });
      const rows = document.getElementById('rows'); rows.innerHTML='';
      (res.data||[]).forEach(r=>{
        const tr = document.createElement('tr');
        tr.innerHTML = `<td>${r.FullName||''}</td><td>${r.Email||''}</td><td>${r.Barcode}</td>
          <td>${r.PhotoUrl? `<img src='${r.PhotoUrl}' style='height:40px'>`:''}</td>
          <td><button class='btn sec' onclick='fill("${r.Id}","${r.UserId}","${r.Barcode}","${r.PhotoUrl||''}")'>Edit</button> <button class='btn sec' onclick='del(${r.Id})'>Delete</button></td>`;
        rows.appendChild(tr);
      });
    }

    function fill(id, userId, code, photo){
      document.getElementById('emp').value = userId;
      document.getElementById('code').value = code;
      document.getElementById('photo').value = photo;
      renderBarcode();
    }

    function genCode(){
      const uid = document.getElementById('emp').value;
      const code = `TEN${tenantId}-EMP${uid}`;
      document.getElementById('code').value = code;
      renderBarcode();
    }

    function renderBarcode(){
      const code = document.getElementById('code').value.trim();
      const preview = document.getElementById('preview');
      preview.innerHTML = `<svg id='svgbarcode'></svg>`;
      try{ JsBarcode('#svgbarcode', code, {format:'CODE128', width:2, height:60, displayValue:true}); }catch(e){}
    }

    function printBarcode(){
      const w = window.open('', 'print');
      w.document.write(`<html><body>${document.getElementById('preview').innerHTML}</body></html>`);
      w.document.close(); w.focus(); w.print(); w.close();
    }

    async function saveMap(){
      const payload = { tenantId, userId: parseInt(document.getElementById('emp').value), barcode: document.getElementById('code').value.trim(), photoUrl: document.getElementById('photo').value.trim() };
      if(!payload.barcode){ alert('Enter barcode'); return; }
      await SafetyAPI.saveAttendanceBarcode(payload);
      loadMaps();
    }

    async function del(id){
      if(!confirm('Delete?')) return; await SafetyAPI.deleteAttendanceBarcode(id); loadMaps();
    }

    loadEmployees();
    loadMaps();
  </script>
</body>
</html>
